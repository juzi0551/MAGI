# MAGI系统人格名称自定义功能实现方案

## 项目概述

本文档详细规划MAGI系统中人格名称自定义功能的实现方案。该功能将允许用户自定义三个核心人格（Melchior-1、Balthasar-2、Casper-3）的显示名称，同时保持内部标识符的稳定性。

## 功能需求

### 核心需求
1. **自定义显示名称**：用户可以修改三个人格的显示名称
2. **保持内部一致性**：内部标识符（melchior/balthasar/casper）保持不变
3. **向后兼容**：现有配置数据不受影响
4. **恢复默认**：支持恢复到默认名称

### 用户体验需求
1. **直观的设置界面**：在人格设置中增加名称编辑功能
2. **实时预览**：修改后立即在界面中反映
3. **批量操作**：支持同时修改多个人格名称

## 技术设计方案

### 1. 数据结构设计

#### 1.1 新增人格配置接口
```typescript
// src/types/config.ts
interface PersonalityConfig {
  id: 'melchior' | 'balthasar' | 'casper';  // 内部标识符，不可变
  displayName: string;                       // 用户自定义显示名称
  subtitle: string;                          // 副标题描述
  customPrompt?: string;                     // 自定义提示词
}

interface PersonalitySettings {
  melchior: PersonalityConfig;
  balthasar: PersonalityConfig;
  casper: PersonalityConfig;
}
```

#### 1.2 扩展用户配置接口
```typescript
// src/types/config.ts - 修改现有接口
export interface UserConfig {
  provider: AIProvider;
  model: string;
  apiKey: string;
  apiBase?: string;
  customBackground?: string;
  
  // 替换原有的 customPrompts
  personalities?: PersonalitySettings;
  
  // 兼容性：保留旧字段用于数据迁移
  customPrompts?: {
    melchior?: string;
    balthasar?: string;
    casper?: string;
  };
}
```

#### 1.3 默认配置
```typescript
// src/config/prompts.ts - 新增默认人格配置
export const DEFAULT_PERSONALITIES: PersonalitySettings = {
  melchior: {
    id: 'melchior',
    displayName: 'MELCHIOR-1',
    subtitle: '科学家',
    customPrompt: ''
  },
  balthasar: {
    id: 'balthasar', 
    displayName: 'BALTHASAR-2',
    subtitle: '母亲',
    customPrompt: ''
  },
  casper: {
    id: 'casper',
    displayName: 'CASPER-3', 
    subtitle: '女人',
    customPrompt: ''
  }
};
```

### 2. 实现步骤规划

#### 阶段一：类型定义和配置基础 (1-2天)

**2.1 类型系统重构**
- [ ] 修改 `src/types/config.ts` - 新增人格配置接口
- [ ] 修改 `src/types/ai.ts` - 扩展 WiseManName 类型支持
- [ ] 更新 `src/config/prompts.ts` - 新增默认人格配置

**2.2 配置上下文升级**
- [ ] 修改 `src/context/ConfigContext.tsx` - 支持新的人格配置
- [ ] 实现配置迁移逻辑 - 从旧格式自动迁移到新格式
- [ ] 添加配置验证 - 确保人格配置完整性

#### 阶段二：服务层适配 (1天)

**2.3 AI服务层重构**
- [ ] 修改 `src/services/ai/aiService.ts:115-116` - 动态获取人格名称
- [ ] 修改 `src/services/ai/magiQueryService.ts:38-39` - 使用配置中的人格信息
- [ ] 新增人格配置工具函数 - 统一人格信息获取接口

#### 阶段三：UI组件适配 (2-3天)

**2.4 设置界面升级**
- [ ] 修改 `src/components/common/SettingsModal.tsx` - 添加人格名称编辑功能
  - 添加人格名称输入框
  - 实现名称验证逻辑
  - 添加"恢复默认名称"功能
- [ ] 优化设置界面布局 - 适应新增的名称设置项

**2.5 显示组件升级**
- [ ] 修改 `src/components/magi/WiseMan.tsx` - 使用动态人格名称
- [ ] 修改 `src/components/magi/WiseAnswerDisplay.tsx` - 显示自定义名称
- [ ] 修改 `src/components/common/HistoryModal.tsx` - 历史记录中的名称显示

**2.6 特殊场景兼容处理**
- [ ] 修改 MAGI 面板核心名称显示 - 保持原始效果的兼容逻辑
- [ ] 修改历史记录详情显示 - 实现名称缓存机制

#### 阶段六：特殊场景兼容处理 (1天)

**2.10 MAGI面板名称显示**
- [ ] 实现 `getMagiPanelDisplayName` 函数 - 原始效果兼容逻辑
- [ ] 修改 MAGI 面板组件 - 使用特殊显示逻辑
- [ ] 确保名称长度适配 - 面板布局兼容性

**2.11 历史记录名称缓存**
- [ ] 扩展 `HistoryRecord` 接口 - 添加人格名称快照字段
- [ ] 实现历史记录创建时的名称快照逻辑
- [ ] 修改历史记录显示组件 - 使用缓存的名称
- [ ] 实现历史记录迁移逻辑 - 兼容旧数据

#### 阶段七：样式和交互优化 (1天)

**2.6 样式适配**
- [ ] 检查并修改 `src/styles/components/magi.css` - CSS Grid布局适配
- [ ] 更新 `src/styles/components/answers.css` - 答案显示样式
- [ ] 确保长名称的响应式显示

**2.7 连接线组件适配**
- [ ] 检查 `src/components/magi/ConnectionLine.tsx` - 确保兼容性

#### 阶段五：测试和文档 (1天)

**2.8 功能测试**
- [ ] 单元测试 - 配置迁移逻辑
- [ ] 集成测试 - 名称修改端到端流程
- [ ] 兼容性测试 - 旧配置数据处理

**2.9 文档更新**
- [ ] 更新用户使用说明
- [ ] 更新开发文档

### 3. 详细实现方案

#### 3.1 设置界面设计

在人格与世界观设定页面中添加：

```
┌─────────────────────────────────────────┐
│ 核心人格 (Core Personalities)           │
├─────────────────────────────────────────┤
│ [Melchior-1] [Balthasar-2] [Casper-3]   │  <- 人格选择标签
├─────────────────────────────────────────┤
│ 人格名称设置                            │
│ ┌─────────────────────────────────────┐ │
│ │ 显示名称: [MELCHIOR-1         ]    │ │
│ │ 副标题:   [科学家            ]    │ │
│ └─────────────────────────────────────┘ │
│ [恢复默认名称]                          │
│                                         │
│ 人格描述设置                            │
│ ┌─────────────────────────────────────┐ │
│ │ [大文本框 - 人格提示词]             │ │
│ └─────────────────────────────────────┘ │
│ [填入默认] [恢复默认]                    │
└─────────────────────────────────────────┘
```

#### 3.2 配置迁移策略

```typescript
// 配置迁移函数
function migratePersonalityConfig(oldConfig: any): PersonalitySettings {
  const defaultPersonalities = DEFAULT_PERSONALITIES;
  
  // 如果存在新格式，直接使用
  if (oldConfig.personalities) {
    return {
      ...defaultPersonalities,
      ...oldConfig.personalities
    };
  }
  
  // 从旧格式迁移
  if (oldConfig.customPrompts) {
    return {
      melchior: {
        ...defaultPersonalities.melchior,
        customPrompt: oldConfig.customPrompts.melchior || ''
      },
      balthasar: {
        ...defaultPersonalities.balthasar,
        customPrompt: oldConfig.customPrompts.balthasar || ''
      },
      casper: {
        ...defaultPersonalities.casper,
        customPrompt: oldConfig.customPrompts.casper || ''
      }
    };
  }
  
  return defaultPersonalities;
}
```

#### 3.3 人格信息获取接口

```typescript
// src/utils/personalityUtils.ts - 新建工具文件
export function getPersonalityDisplayName(
  personalityId: string, 
  config?: PersonalitySettings
): string {
  if (!config || !config[personalityId]) {
    return DEFAULT_PERSONALITIES[personalityId]?.displayName || personalityId.toUpperCase();
  }
  
  const personality = config[personalityId];
  return `${personality.displayName} (${personality.subtitle})`;
}

export function getPersonalityFullName(
  personalityId: string,
  config?: PersonalitySettings  
): string {
  const personality = config?.[personalityId] || DEFAULT_PERSONALITIES[personalityId];
  return `${personality.displayName} (${personality.subtitle})`;
}
```

#### 3.4 特殊场景处理方案

**3.4.1 MAGI面板核心名称显示逻辑**

MAGI面板上的核心名称需要特殊处理，以保持原始效果：

```typescript
// src/utils/personalityUtils.ts - 新增函数
export function getMagiPanelDisplayName(
  personalityId: PersonalityId,
  config?: PersonalitySettings
): string {
  const personality = config?.[personalityId];
  
  // 如果没有自定义名称，使用原始默认名称（保持原始效果）
  if (!personality || !personality.displayName || 
      personality.displayName === DEFAULT_PERSONALITIES[personalityId].displayName) {
    // 返回原始的短名称格式
    switch (personalityId) {
      case 'melchior': return 'MELCHIOR';
      case 'balthasar': return 'BALTHASAR';
      case 'casper': return 'CASPER';
      default: return personalityId.toUpperCase();
    }
  }
  
  // 如果有自定义名称，使用自定义的显示名称（不含副标题）
  return personality.displayName;
}
```

**3.4.2 历史记录名称缓存机制**

由于历史记录的特殊性，需要在保存时缓存当时的人格名称：

```typescript
// src/types/history.ts - 扩展历史记录接口
export interface HistoryRecord {
  id: string;
  question: string;
  questionType: QuestionType;
  wiseManAnswers: WiseManAnswer[];
  finalStatus: FinalStatus;
  timestamp: number;
  processingTime: number;
  
  // 新增：保存创建时的人格名称映射
  personalityNamesSnapshot?: {
    melchior: string;
    balthasar: string;
    casper: string;
  };
}

// 历史记录创建时的名称快照逻辑
export function createPersonalitySnapshot(
  personalities?: PersonalitySettings
): HistoryRecord['personalityNamesSnapshot'] {
  return {
    melchior: getPersonalityFullName('melchior', personalities),
    balthasar: getPersonalityFullName('balthasar', personalities),
    casper: getPersonalityFullName('casper', personalities)
  };
}

// 历史记录显示时的名称获取
export function getHistoryPersonalityName(
  personalityId: PersonalityId,
  record: HistoryRecord,
  currentConfig?: PersonalitySettings
): string {
  // 优先使用历史快照中的名称
  if (record.personalityNamesSnapshot) {
    return record.personalityNamesSnapshot[personalityId];
  }
  
  // 回退到当前配置（用于兼容旧记录）
  return getPersonalityFullName(personalityId, currentConfig);
}
```

**3.4.3 数据迁移和兼容性处理**

```typescript
// 历史记录迁移逻辑
export function migrateHistoryRecord(
  record: HistoryRecord,
  currentPersonalities?: PersonalitySettings
): HistoryRecord {
  // 如果已经有快照，直接返回
  if (record.personalityNamesSnapshot) {
    return record;
  }
  
  // 为旧记录创建快照（使用当前配置作为最佳猜测）
  return {
    ...record,
    personalityNamesSnapshot: createPersonalitySnapshot(currentPersonalities)
  };
}
```

### 4. 风险评估与应对

#### 4.1 技术风险
- **配置兼容性**：通过迁移逻辑确保旧配置平滑升级
- **类型安全**：使用 TypeScript 严格类型检查
- **性能影响**：配置读取次数较少，性能影响可忽略

#### 4.2 用户体验风险
- **学习成本**：设计直观的界面，提供明确的操作提示
- **数据丢失**：实现完善的备份和恢复机制

### 5. 测试策略

#### 5.1 单元测试
- 配置迁移函数测试
- 人格信息获取函数测试
- 名称验证逻辑测试

#### 5.2 集成测试
- 设置保存和加载流程
- 人格名称显示一致性
- 多人格同时修改场景

#### 5.3 用户验收测试
- 名称修改功能完整性
- 界面响应性和易用性
- 数据持久化正确性

### 6. 发布计划

#### 6.1 发布准备
- [ ] 完成所有开发任务
- [ ] 通过测试验证
- [ ] 更新版本号和更新日志

#### 6.2 发布后监控
- [ ] 用户反馈收集
- [ ] 性能指标监控
- [ ] Bug报告处理

## 总结

本方案通过引入新的人格配置结构，在保持系统稳定性的同时实现了人格名称的自定义功能。实现过程分为7个阶段，包含特殊场景的兼容处理，预计总开发时间7-9天。通过完善的测试策略和风险应对措施，确保功能的稳定性和用户体验。

**特殊场景处理**：
1. **MAGI面板名称显示**：保持原始简洁效果的同时支持自定义名称
2. **历史记录名称缓存**：确保历史数据的准确性和一致性

---

**文档版本**: v2.0  
**创建日期**: 2025-08-02  
**最后更新**: 2025-08-02  
**负责人**: Claude Code Assistant