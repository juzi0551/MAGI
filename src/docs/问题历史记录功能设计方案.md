# MAGIç³»ç»Ÿé—®é¢˜å†å²è®°å½•åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## åŠŸèƒ½æ¦‚è¿°

ä¸ºMAGIç³»ç»Ÿæ·»åŠ åŸºäºæµè§ˆå™¨æœ¬åœ°ç¼“å­˜ï¼ˆlocalStorageï¼‰çš„é—®é¢˜å†å²è®°å½•åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹å’Œé‡æ–°æé—®ä¹‹å‰çš„é—®é¢˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿå®ç”¨æ€§ã€‚

## è®¾è®¡ç›®æ ‡

1. **æ— ä¾µå…¥æ€§**: ä¸å½±å“ç°æœ‰åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œ
2. **æœ¬åœ°å­˜å‚¨**: ä½¿ç”¨æµè§ˆå™¨localStorageï¼Œæ— éœ€åç«¯æ”¯æŒ
3. **ç®€æ´ç›´è§‚**: æä¾›ç®€å•æ¸…æ™°çš„å†å²è®°å½•å±•ç¤º
4. **éšç§ä¿æŠ¤**: æ•°æ®ä»…å­˜å‚¨åœ¨ç”¨æˆ·æœ¬åœ°æµè§ˆå™¨ä¸­

## åŠŸèƒ½ç‰¹æ€§

- **è‡ªåŠ¨è®°å½•**: æ¯æ¬¡æé—®è‡ªåŠ¨ä¿å­˜åˆ°å†å²è®°å½•
- **å†å²å±•ç¤º**: ç®€å•å±•ç¤ºå†å²é—®é¢˜åˆ—è¡¨ï¼ŒåŒ…å«é—®é¢˜å†…å®¹ã€æ—¶é—´ã€çŠ¶æ€
- **å¿«é€Ÿé‡é—®**: ç‚¹å‡»å†å²è®°å½•å¯å¿«é€Ÿé‡æ–°æé—®
- **æ¸…ç©ºå†å²**: ä¸€é”®æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
- **çŠ¶æ€æ˜¾ç¤º**: æ˜¾ç¤ºæ¯ä¸ªå†å²é—®é¢˜çš„æœ€ç»ˆå†³ç­–çŠ¶æ€

## ç•Œé¢è®¾è®¡

### å¸ƒå±€ä½ç½®
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MAGIç³»ç»Ÿä¸»ç•Œé¢                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚                 â”‚                                        â”‚
â”‚  â”‚   MAGIç³»ç»Ÿ      â”‚                                        â”‚
â”‚  â”‚   (ç°æœ‰ç•Œé¢)     â”‚                                        â”‚
â”‚  â”‚                 â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† æ–°å¢ï¼šå†å²è®°å½•åŒºåŸŸ                   â”‚
â”‚  â”‚  ğŸ“š é—®é¢˜å†å² [æ¸…ç©º] â”‚                                      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                        â”‚
â”‚  â”‚  â”‚ å†å²è®°å½•1   â”‚ â”‚                                        â”‚
â”‚  â”‚  â”‚ å†å²è®°å½•2   â”‚ â”‚                                        â”‚
â”‚  â”‚  â”‚ å†å²è®°å½•3   â”‚ â”‚                                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚   é—®é¢˜è¾“å…¥æ¡†     â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†å²è®°å½•é¡¹è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ• 2024-01-15 14:30:25                    [çŠ¶æ€: åˆæ„]      â”‚
â”‚ é—®é¢˜: æˆ‘ä»¬åº”è¯¥ä½¿ç”¨äººå·¥æ™ºèƒ½æ¥è‡ªåŠ¨åŒ–å®¢æœå—ï¼Ÿ                   â”‚
â”‚ (ç‚¹å‡»æ•´ä¸ªåŒºåŸŸå¯é‡æ–°æé—®)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ‡é¢˜æ è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“š é—®é¢˜å†å²                                    [æ¸…ç©ºå†å²]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®ç»“æ„è®¾è®¡

### å†å²è®°å½•æ•°æ®æ¨¡å‹
```javascript
{
  id: "unique_id",                    // å”¯ä¸€æ ‡è¯†ç¬¦
  timestamp: 1705312225000,           // æ—¶é—´æˆ³
  question: "é—®é¢˜å†…å®¹",               // é—®é¢˜æ–‡æœ¬
  questionType: "yes_no" | "info",    // é—®é¢˜ç±»å‹
  finalStatus: "yes|no|conditional|info|error", // æœ€ç»ˆçŠ¶æ€
  answers: [                          // ä¸‰ä¸ªäººæ ¼çš„å›ç­”
    {
      name: "melchior",
      status: "yes|no|conditional|info|error",
      response: "å›ç­”å†…å®¹",
      conditions: "æ¡ä»¶ä¿¡æ¯"
    },
    // ... balthasar, casper
  ],
  metadata: {
    provider: "openrouter",           // AIæä¾›å•†
    model: "gemini-2.5-flash",        // ä½¿ç”¨çš„æ¨¡å‹
    processingTime: 3500              // å¤„ç†æ—¶é—´(ms)
  }
}
```

### localStorageå­˜å‚¨ç»“æ„
```javascript
// å­˜å‚¨é”®å
const STORAGE_KEY = 'magi_question_history';

// å†å²è®°å½•å­˜å‚¨æ ¼å¼
{
  version: "1.0",                     // æ•°æ®ç‰ˆæœ¬
  records: [...],                     // å†å²è®°å½•æ•°ç»„
  lastUpdated: 1705312225000          // æœ€åæ›´æ–°æ—¶é—´
}
```

## æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. æ–°å¢Reactç»„ä»¶

#### HistoryPanelç»„ä»¶ (components/history_panel.js)
```javascript
// å†å²è®°å½•é¢æ¿ä¸»ç»„ä»¶
const HistoryPanel = ({
  records,
  onQuestionSelect,
  onClearHistory
}) => {
  // ç»„ä»¶é€»è¾‘ï¼š
  // - æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨
  // - å¤„ç†ç‚¹å‡»é‡æ–°æé—®
  // - å¤„ç†æ¸…ç©ºå†å²æŒ‰é’®
};
```

#### HistoryItemç»„ä»¶ (components/history_item.js)
```javascript
// å•ä¸ªå†å²è®°å½•é¡¹ç»„ä»¶
const HistoryItem = ({
  record,
  onReask
}) => {
  // ç»„ä»¶é€»è¾‘ï¼š
  // - æ˜¾ç¤ºé—®é¢˜å†…å®¹ã€æ—¶é—´ã€çŠ¶æ€
  // - ç‚¹å‡»æ•´ä¸ªåŒºåŸŸè§¦å‘é‡æ–°æé—®
};
```

### 2. æ•°æ®ç®¡ç†æ¨¡å—

#### history_utils.js (å‰ç«¯å·¥å…·å‡½æ•°)
```javascript
// å‰ç«¯localStorageæ“ä½œå·¥å…·
const HistoryUtils = {
  saveRecord: (record) => { /* ä¿å­˜è®°å½• */ },
  getRecords: () => { /* è·å–æ‰€æœ‰è®°å½• */ },
  clearAll: () => { /* æ¸…ç©ºæ‰€æœ‰è®°å½• */ }
};
```

### 3. ä¸»åº”ç”¨é›†æˆ

#### main.pyä¿®æ”¹ç‚¹
```python
# 1. æ·»åŠ å†å²è®°å½•ç›¸å…³çš„Storeç»„ä»¶
dcc.Store(id='history-records', data=[]),

# 2. æ·»åŠ å†å²è®°å½•é¢æ¿åˆ°å¸ƒå±€
HistoryPanel(
    id='history-panel'
),

# 3. æ·»åŠ å†å²è®°å½•ç›¸å…³çš„å›è°ƒå‡½æ•°
@callback(
    Output('history-records', 'data'),
    Input('response', 'status'),
    State('question', 'data'),
    State({'type': 'wise-man', 'name': ALL}, 'answer')
)
def save_to_history(status, question, answers):
    """ä¿å­˜å®Œæˆçš„é—®ç­”åˆ°å†å²è®°å½•"""
    pass

@callback(
    Output('query', 'value'),
    Input('history-panel', 'selectedQuestion')
)
def reask_from_history(selected_question):
    """ä»å†å²è®°å½•é‡æ–°æé—®"""
    pass

@callback(
    Output('history-records', 'data', allow_duplicate=True),
    Input('history-panel', 'clearHistory'),
    prevent_initial_call=True
)
def clear_history(clear_trigger):
    """æ¸…ç©ºå†å²è®°å½•"""
    return []
```

## æ ·å¼è®¾è®¡

### CSSæ ·å¼è§„èŒƒ
```css
/* å†å²è®°å½•é¢æ¿æ ·å¼ */
.history-panel {
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  border: 2px solid #ff8d00;
  border-radius: 8px;
  margin: 10px 0;
  padding: 15px;
  max-height: 300px;
  overflow-y: auto;
}

/* å†å²è®°å½•é¡¹æ ·å¼ */
.history-item {
  background: rgba(255, 141, 0, 0.1);
  border: 1px solid #ff8d00;
  border-radius: 4px;
  margin: 8px 0;
  padding: 12px;
  transition: all 0.3s ease;
}

.history-item:hover {
  background: rgba(255, 141, 0, 0.2);
  transform: translateX(5px);
}

/* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
.status-tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
  margin-left: 10px;
}

.status-yes { background: #52e691; color: black; }
.status-no { background: #a41413; color: white; }
.status-conditional { background: #ff8d00; color: black; }
.status-info { background: #3caee0; color: black; }
.status-error { background: gray; color: white; }

/* æ¸…ç©ºæŒ‰é’®æ ·å¼ */
.clear-history-btn {
  background: rgba(255, 141, 0, 0.2);
  border: 1px solid #ff8d00;
  color: #ff8d00;
  padding: 4px 12px;
  border-radius: 4px;
  font-family: 'MAGI-Matisse', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.clear-history-btn:hover {
  background: rgba(255, 141, 0, 0.4);
}

/* æ ‡é¢˜æ æ ·å¼ */
.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid #ff8d00;
}

.history-title {
  color: #ff8d00;
  font-family: 'MAGI-Matisse', monospace;
  font-size: 14px;
  font-weight: bold;
}
```

## å®ç°æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½
1. **åˆ›å»ºå†å²è®°å½•ç»„ä»¶**
   - å®ç°HistoryPanelåŸºç¡€ç»„ä»¶
   - å®ç°HistoryItemå­ç»„ä»¶
   - æ·»åŠ åˆ°main.pyå¸ƒå±€ä¸­

2. **å®ç°æ•°æ®å­˜å‚¨**
   - åˆ›å»ºlocalStorageæ“ä½œå·¥å…·å‡½æ•°
   - å®ç°é—®ç­”è®°å½•çš„è‡ªåŠ¨ä¿å­˜
   - æ·»åŠ æ•°æ®ç‰ˆæœ¬ç®¡ç†

3. **åŸºç¡€ç•Œé¢å®ç°**
   - å†å²è®°å½•åˆ—è¡¨æ˜¾ç¤º
   - æ—¶é—´æ ¼å¼åŒ–æ˜¾ç¤º
   - çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º
   - æ¸…ç©ºå†å²æŒ‰é’®

### ç¬¬äºŒé˜¶æ®µï¼šäº¤äº’åŠŸèƒ½
1. **é‡æ–°æé—®åŠŸèƒ½**
   - ç‚¹å‡»å†å²è®°å½•å¡«å……è¾“å…¥æ¡†
   - è‡ªåŠ¨è§¦å‘é—®é¢˜å¤„ç†æµç¨‹

2. **æ¸…ç©ºå†å²åŠŸèƒ½**
   - æ¸…ç©ºæŒ‰é’®å®ç°
   - ç¡®è®¤å¯¹è¯æ¡†
   - localStorageæ¸…ç†

### ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å®Œå–„
1. **æ€§èƒ½ä¼˜åŒ–**
   - è®°å½•è¿‡å¤šæ—¶çš„æ»šåŠ¨ä¼˜åŒ–
   - æ•°æ®åŠ è½½ä¼˜åŒ–

2. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - ç‚¹å‡»åé¦ˆæ•ˆæœ
   - æ¸…ç©ºç¡®è®¤æç¤º

## æ•°æ®ç®¡ç†ç­–ç•¥

### æ•°æ®å®Œæ•´æ€§
- **ç‰ˆæœ¬æ§åˆ¶**: æ•°æ®ç»“æ„ç‰ˆæœ¬åŒ–ï¼Œæ”¯æŒå‡çº§è¿ç§»
- **é”™è¯¯å¤„ç†**: localStorageæ“ä½œå¼‚å¸¸å¤„ç†
- **æ•°æ®æ ¡éªŒ**: è¯»å–æ—¶éªŒè¯æ•°æ®æ ¼å¼

### éšç§ä¿æŠ¤
- **æœ¬åœ°å­˜å‚¨**: æ•°æ®ä»…å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸­
- **æ¸…ç©ºåŠŸèƒ½**: æä¾›ä¸€é”®æ¸…é™¤æ‰€æœ‰æ•°æ®åŠŸèƒ½
- **æ•æ„Ÿä¿¡æ¯**: ä¸å­˜å‚¨APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯

## å…¼å®¹æ€§è€ƒè™‘

### æµè§ˆå™¨å…¼å®¹æ€§
- **localStorageæ”¯æŒ**: ç°ä»£æµè§ˆå™¨å…¨é¢æ”¯æŒ
- **é™çº§æ–¹æ¡ˆ**: ä¸æ”¯æŒæ—¶ç¦ç”¨å†å²åŠŸèƒ½ï¼Œä¸å½±å“ä¸»åŠŸèƒ½
- **å­˜å‚¨é™åˆ¶**: å¤„ç†ä¸åŒæµè§ˆå™¨çš„å­˜å‚¨é™åˆ¶å·®å¼‚

### ç°æœ‰åŠŸèƒ½å…¼å®¹
- **æ— ä¾µå…¥è®¾è®¡**: ä¸ä¿®æ”¹ç°æœ‰æ ¸å¿ƒé€»è¾‘
- **å¯é€‰åŠŸèƒ½**: å¯é€šè¿‡é…ç½®å¼€å¯/å…³é—­
- **æ¸è¿›å¢å¼º**: ä½œä¸ºé™„åŠ åŠŸèƒ½ï¼Œä¸å½±å“åŸºç¡€ä½¿ç”¨

## æµ‹è¯•æ–¹æ¡ˆ

### åŠŸèƒ½æµ‹è¯•
1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•**
   - è®°å½•ä¿å­˜å’Œè¯»å–
   - ç•Œé¢æ˜¾ç¤ºå’Œäº¤äº’
   - é‡æ–°æé—®åŠŸèƒ½
   - æ¸…ç©ºå†å²åŠŸèƒ½

2. **å…¼å®¹æ€§æµ‹è¯•**
   - ä¸åŒæµè§ˆå™¨æµ‹è¯•
   - localStorageç¦ç”¨æƒ…å†µ
   - æ•°æ®ç‰ˆæœ¬å‡çº§æµ‹è¯•

## æ€»ç»“

è¿™ä¸ªé—®é¢˜å†å²è®°å½•åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆé‡‡ç”¨ç®€æ´ç›´è§‚çš„è®¾è®¡ç†å¿µï¼Œåœ¨ä¸å½±å“ç°æœ‰åŠŸèƒ½çš„å‰æä¸‹ï¼Œä¸ºMAGIç³»ç»Ÿæ·»åŠ å®ç”¨çš„å†å²è®°å½•åŠŸèƒ½ã€‚

è¯¥æ–¹æ¡ˆçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š
- **ç®€æ´æ˜äº†**: åªä¿ç•™æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œé¿å…å¤æ‚æ“ä½œ
- **æ— ä¾µå…¥æ€§**: ä¸å½±å“ç°æœ‰åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œ
- **æœ¬åœ°åŒ–**: ä¿æŠ¤ç”¨æˆ·éšç§ï¼Œæ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°
- **æ˜“äºä½¿ç”¨**: ç‚¹å‡»å³å¯é‡æ–°æé—®ï¼Œä¸€é”®æ¸…ç©ºå†å²
- **è§†è§‰ç»Ÿä¸€**: ä¸ç°æœ‰MAGIç³»ç»Ÿç•Œé¢é£æ ¼ä¿æŒä¸€è‡´

é€šè¿‡è¿™ä¸ªç®€åŒ–çš„å†å²è®°å½•åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°æŸ¥çœ‹å’Œé‡ç”¨ä¹‹å‰çš„é—®é¢˜ï¼Œæå‡ä½¿ç”¨æ•ˆç‡å’Œä½“éªŒã€‚
