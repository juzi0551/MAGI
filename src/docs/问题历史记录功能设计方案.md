# MAGI系统问题历史记录功能设计方案

## 功能概述

为MAGI系统添加基于浏览器本地缓存（localStorage）的问题历史记录功能，允许用户查看和重新提问之前的问题，提升用户体验和系统实用性。

## 设计目标

1. **无侵入性**: 不影响现有功能的正常运行
2. **本地存储**: 使用浏览器localStorage，无需后端支持
3. **简洁直观**: 提供简单清晰的历史记录展示
4. **隐私保护**: 数据仅存储在用户本地浏览器中

## 功能特性

- **自动记录**: 每次提问自动保存到历史记录
- **历史展示**: 简单展示历史问题列表，包含问题内容、时间、状态
- **快速重问**: 点击历史记录可快速重新提问
- **清空历史**: 一键清空所有历史记录
- **状态显示**: 显示每个历史问题的最终决策状态

## 界面设计

### 布局位置
```
┌─────────────────────────────────────────────────────────────┐
│                    MAGI系统主界面                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐                                        │
│  │                 │                                        │
│  │   MAGI系统      │                                        │
│  │   (现有界面)     │                                        │
│  │                 │                                        │
│  └─────────────────┘                                        │
│  ┌─────────────────┐  ← 新增：历史记录区域                   │
│  │  📚 问题历史 [清空] │                                      │
│  │  ┌─────────────┐ │                                        │
│  │  │ 历史记录1   │ │                                        │
│  │  │ 历史记录2   │ │                                        │
│  │  │ 历史记录3   │ │                                        │
│  │  └─────────────┘ │                                        │
│  └─────────────────┘                                        │
│  ┌─────────────────┐                                        │
│  │   问题输入框     │                                        │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
```

### 历史记录项设计
```
┌─────────────────────────────────────────────────────────────┐
│ 🕐 2024-01-15 14:30:25                    [状态: 合意]      │
│ 问题: 我们应该使用人工智能来自动化客服吗？                   │
│ (点击整个区域可重新提问)                                     │
└─────────────────────────────────────────────────────────────┘
```

### 标题栏设计
```
┌─────────────────────────────────────────────────────────────┐
│ 📚 问题历史                                    [清空历史]   │
└─────────────────────────────────────────────────────────────┘
```

## 数据结构设计

### 历史记录数据模型
```javascript
{
  id: "unique_id",                    // 唯一标识符
  timestamp: 1705312225000,           // 时间戳
  question: "问题内容",               // 问题文本
  questionType: "yes_no" | "info",    // 问题类型
  finalStatus: "yes|no|conditional|info|error", // 最终状态
  answers: [                          // 三个人格的回答
    {
      name: "melchior",
      status: "yes|no|conditional|info|error",
      response: "回答内容",
      conditions: "条件信息"
    },
    // ... balthasar, casper
  ],
  metadata: {
    provider: "openrouter",           // AI提供商
    model: "gemini-2.5-flash",        // 使用的模型
    processingTime: 3500              // 处理时间(ms)
  }
}
```

### localStorage存储结构
```javascript
// 存储键名
const STORAGE_KEY = 'magi_question_history';

// 历史记录存储格式
{
  version: "1.0",                     // 数据版本
  records: [...],                     // 历史记录数组
  lastUpdated: 1705312225000          // 最后更新时间
}
```

## 技术实现方案

### 1. 新增React组件

#### HistoryPanel组件 (components/history_panel.js)
```javascript
// 历史记录面板主组件
const HistoryPanel = ({
  records,
  onQuestionSelect,
  onClearHistory
}) => {
  // 组件逻辑：
  // - 显示历史记录列表
  // - 处理点击重新提问
  // - 处理清空历史按钮
};
```

#### HistoryItem组件 (components/history_item.js)
```javascript
// 单个历史记录项组件
const HistoryItem = ({
  record,
  onReask
}) => {
  // 组件逻辑：
  // - 显示问题内容、时间、状态
  // - 点击整个区域触发重新提问
};
```

### 2. 数据管理模块

#### history_utils.js (前端工具函数)
```javascript
// 前端localStorage操作工具
const HistoryUtils = {
  saveRecord: (record) => { /* 保存记录 */ },
  getRecords: () => { /* 获取所有记录 */ },
  clearAll: () => { /* 清空所有记录 */ }
};
```

### 3. 主应用集成

#### main.py修改点
```python
# 1. 添加历史记录相关的Store组件
dcc.Store(id='history-records', data=[]),

# 2. 添加历史记录面板到布局
HistoryPanel(
    id='history-panel'
),

# 3. 添加历史记录相关的回调函数
@callback(
    Output('history-records', 'data'),
    Input('response', 'status'),
    State('question', 'data'),
    State({'type': 'wise-man', 'name': ALL}, 'answer')
)
def save_to_history(status, question, answers):
    """保存完成的问答到历史记录"""
    pass

@callback(
    Output('query', 'value'),
    Input('history-panel', 'selectedQuestion')
)
def reask_from_history(selected_question):
    """从历史记录重新提问"""
    pass

@callback(
    Output('history-records', 'data', allow_duplicate=True),
    Input('history-panel', 'clearHistory'),
    prevent_initial_call=True
)
def clear_history(clear_trigger):
    """清空历史记录"""
    return []
```

## 样式设计

### CSS样式规范
```css
/* 历史记录面板样式 */
.history-panel {
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  border: 2px solid #ff8d00;
  border-radius: 8px;
  margin: 10px 0;
  padding: 15px;
  max-height: 300px;
  overflow-y: auto;
}

/* 历史记录项样式 */
.history-item {
  background: rgba(255, 141, 0, 0.1);
  border: 1px solid #ff8d00;
  border-radius: 4px;
  margin: 8px 0;
  padding: 12px;
  transition: all 0.3s ease;
}

.history-item:hover {
  background: rgba(255, 141, 0, 0.2);
  transform: translateX(5px);
}

/* 状态标签样式 */
.status-tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
  margin-left: 10px;
}

.status-yes { background: #52e691; color: black; }
.status-no { background: #a41413; color: white; }
.status-conditional { background: #ff8d00; color: black; }
.status-info { background: #3caee0; color: black; }
.status-error { background: gray; color: white; }

/* 清空按钮样式 */
.clear-history-btn {
  background: rgba(255, 141, 0, 0.2);
  border: 1px solid #ff8d00;
  color: #ff8d00;
  padding: 4px 12px;
  border-radius: 4px;
  font-family: 'MAGI-Matisse', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.clear-history-btn:hover {
  background: rgba(255, 141, 0, 0.4);
}

/* 标题栏样式 */
.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid #ff8d00;
}

.history-title {
  color: #ff8d00;
  font-family: 'MAGI-Matisse', monospace;
  font-size: 14px;
  font-weight: bold;
}
```

## 实现步骤

### 第一阶段：基础功能
1. **创建历史记录组件**
   - 实现HistoryPanel基础组件
   - 实现HistoryItem子组件
   - 添加到main.py布局中

2. **实现数据存储**
   - 创建localStorage操作工具函数
   - 实现问答记录的自动保存
   - 添加数据版本管理

3. **基础界面实现**
   - 历史记录列表显示
   - 时间格式化显示
   - 状态标签显示
   - 清空历史按钮

### 第二阶段：交互功能
1. **重新提问功能**
   - 点击历史记录填充输入框
   - 自动触发问题处理流程

2. **清空历史功能**
   - 清空按钮实现
   - 确认对话框
   - localStorage清理

### 第三阶段：优化完善
1. **性能优化**
   - 记录过多时的滚动优化
   - 数据加载优化

2. **用户体验优化**
   - 点击反馈效果
   - 清空确认提示

## 数据管理策略

### 数据完整性
- **版本控制**: 数据结构版本化，支持升级迁移
- **错误处理**: localStorage操作异常处理
- **数据校验**: 读取时验证数据格式

### 隐私保护
- **本地存储**: 数据仅存储在用户浏览器中
- **清空功能**: 提供一键清除所有数据功能
- **敏感信息**: 不存储API密钥等敏感信息

## 兼容性考虑

### 浏览器兼容性
- **localStorage支持**: 现代浏览器全面支持
- **降级方案**: 不支持时禁用历史功能，不影响主功能
- **存储限制**: 处理不同浏览器的存储限制差异

### 现有功能兼容
- **无侵入设计**: 不修改现有核心逻辑
- **可选功能**: 可通过配置开启/关闭
- **渐进增强**: 作为附加功能，不影响基础使用

## 测试方案

### 功能测试
1. **基础功能测试**
   - 记录保存和读取
   - 界面显示和交互
   - 重新提问功能
   - 清空历史功能

2. **兼容性测试**
   - 不同浏览器测试
   - localStorage禁用情况
   - 数据版本升级测试

## 总结

这个问题历史记录功能设计方案采用简洁直观的设计理念，在不影响现有功能的前提下，为MAGI系统添加实用的历史记录功能。

该方案的核心优势：
- **简洁明了**: 只保留最核心的功能，避免复杂操作
- **无侵入性**: 不影响现有功能的正常运行
- **本地化**: 保护用户隐私，数据仅存储在本地
- **易于使用**: 点击即可重新提问，一键清空历史
- **视觉统一**: 与现有MAGI系统界面风格保持一致

通过这个简化的历史记录功能，用户可以方便地查看和重用之前的问题，提升使用效率和体验。
