# MAGI系统 React+Vite 重构技术方案

## 1. 项目概述

MAGI系统是一个基于《新世纪福音战士》中的超级计算机系统设计的Web应用，通过三个不同人格（科学家、母亲、女人）对用户问题进行分析和决策。本文档提出使用React+Vite框架对现有基于Dash的MAGI系统进行重构，以提升开发体验、性能和可维护性。

## 2. 技术选型

### 2.1 核心技术栈

- **前端框架**: React 19.2（2025年稳定版）
- **构建工具**: Vite 6.5（成熟稳定版）
- **语言**: TypeScript 6.0
- **状态管理**: Zustand 6.0（轻量级状态管理）
- **路由**: React Router 7.1（稳定版）
- **样式方案**: CSS Modules + CSS变量 + Tailwind CSS 4.2
- **HTTP客户端**: TanStack Query 7（前身为React Query）
- **测试框架**: Jest 30 + React Testing Library

### 2.2 技术选型理由

- **React+Vite vs Dash**:
  - 更灵活的前端开发体验和组件化能力
  - 更快的热重载和构建速度（Vite的优势）
  - 更丰富的生态系统和社区支持
  - 更好的TypeScript集成，提升代码质量和开发体验
  - 更容易实现复杂的UI交互和动画效果

- **不使用UI框架的原因**:
  - MAGI系统UI高度定制化，需要精确还原EVA原作风格
  - 现有组件和样式已经完善，可以直接迁移
  - 减少不必要的依赖，保持应用轻量
  - 避免与第三方UI框架的设计理念冲突

## 3. 系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      用户浏览器                              │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    React 应用                       │    │
│  │                                                     │    │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────┐  │    │
│  │  │  组件系统    │    │  状态管理    │    │ 服务层  │  │    │
│  │  └─────────────┘    └─────────────┘    └─────────┘  │    │
│  │         │                  │                 │      │    │
│  │         ▼                  ▼                 ▼      │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │              本地存储 (localStorage)        │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
│                             │                               │
└─────────────────────────────┼───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       外部 AI API                           │
│  (OpenRouter, OpenAI, Anthropic, Google, 智谱, 月之暗面等)   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 目录结构

```
magi-system/
├── public/                  # 静态资源
│   ├── fonts/               # 字体文件
│   └── favicon.ico          # 网站图标
├── src/
│   ├── assets/              # 项目资源
│   │   ├── audio/           # 音频文件
│   │   └── images/          # 图片资源
│   ├── components/          # 组件
│   │   ├── common/          # 通用组件
│   │   ├── layout/          # 布局组件
│   │   └── magi/            # MAGI系统特有组件
│   ├── context/             # React Context
│   │   ├── ConfigContext.ts # 配置上下文
│   │   ├── HistoryContext.ts# 历史记录上下文
│   │   └── MagiContext.ts   # MAGI系统状态上下文
│   ├── hooks/               # 自定义Hooks
│   │   ├── useAiService.ts  # AI服务Hook
│   │   ├── useLocalStorage.ts # 本地存储Hook
│   │   └── useMagiAudio.ts  # 音频效果Hook
│   ├── services/            # 服务层
│   │   ├── aiService.ts     # AI服务
│   │   ├── configStorage.ts # 配置存储服务
│   │   └── historyStorage.ts# 历史记录存储服务
│   ├── styles/              # 样式文件
│   │   ├── base/            # 基础样式
│   │   ├── components/      # 组件样式
│   │   └── variables.css    # CSS变量
│   ├── types/               # TypeScript类型定义
│   │   ├── ai.ts            # AI相关类型
│   │   ├── config.ts        # 配置相关类型
│   │   └── history.ts       # 历史记录相关类型
│   ├── utils/               # 工具函数
│   │   ├── formatters.ts    # 格式化工具
│   │   └── statusUtils.ts   # 状态工具
│   ├── App.tsx              # 应用入口组件
│   ├── main.tsx             # 应用入口文件
│   └── vite-env.d.ts        # Vite类型声明
├── .eslintrc.js             # ESLint配置
├── .gitignore               # Git忽略文件
├── index.html               # HTML模板
├── package.json             # 项目依赖
├── tsconfig.json            # TypeScript配置
├── vite.config.ts           # Vite配置
└── README.md                # 项目说明
```

## 4. 核心功能模块设计

### 4.1 MAGI系统核心组件

#### 4.1.1 组件层次结构

```
MagiSystem (根组件)
├── MagiContainer (MAGI主容器)
│   ├── Header (左右标题)
│   ├── Status (系统状态)
│   ├── WiseMan (三贤人组件，3个实例)
│   └── Response (响应状态)
├── HistoryPanel (历史记录面板)
│   └── HistoryItem (历史记录项)
├── SettingsModal (设置模态框)
└── HistoryDetailModal (历史详情模态框)
```

#### 4.1.2 核心组件职责

- **MagiSystem**: 应用根组件，负责整体布局和状态协调
- **MagiContainer**: MAGI系统的主视觉容器，包含三角形连接线和标题
- **WiseMan**: 三贤人组件，根据状态显示不同颜色和形状
- **Response**: 显示系统最终决策状态
- **Status**: 显示系统运行状态信息
- **HistoryPanel**: 历史记录面板，可折叠显示
- **SettingsModal**: 用户配置模态框，管理API密钥等设置

### 4.2 状态管理设计

#### 4.2.1 状态层次结构

使用React Context API和useReducer实现状态管理，分为三个主要Context:

1. **MagiContext**: 核心应用状态
   - 问题和问题类型
   - 系统状态（待机、处理中、完成）
   - 三贤者状态和回答
   - 最终决策状态
   - 状态刷新触发器
   - 人格设定

2. **ConfigContext**: 用户配置状态
   - API提供商
   - 模型选择
   - API密钥
   - API基础URL

3. **HistoryContext**: 历史记录状态
   - 历史记录列表
   - 当前选中记录
   - 历史记录操作方法

#### 4.2.2 状态更新流程

1. 用户输入问题
2. 更新系统状态为"处理中"
3. 判断问题类型（是/否问题或信息查询）
4. 获取三贤者回答
5. 更新贤者状态和回答
6. 计算最终决策状态
7. 保存到历史记录
8. 更新系统状态为"完成"

### 4.3 AI服务设计

#### 4.3.1 服务架构

AI服务层负责与外部AI API的交互，主要功能包括：

1. **问题类型判断**: 判断用户输入是否为是/否问题
2. **贤者回答获取**: 根据不同人格获取AI回答
3. **回答状态分类**: 将回答分类为yes/no/conditional/info/error
4. **最终状态计算**: 根据三个贤者的状态计算最终决策

#### 4.3.2 多供应商支持

支持多种AI服务提供商，包括：
- OpenRouter（默认，聚合多种模型）
- OpenAI
- Anthropic
- Google
- 智谱AI
- 月之暗面
- 阿里云通义千问
- 百度文心千帆
- DeepSeek

用户可以在设置中选择供应商并配置自己的API密钥。

### 4.4 本地存储设计

#### 4.4.1 存储模块

使用浏览器localStorage实现本地存储，分为三个主要模块：

1. **configStorage**: 用户配置存储
   - API密钥
   - 模型选择
   - 供应商设置

2. **historyStorage**: 历史记录存储
   - 问题记录
   - 回答记录
   - 状态记录

3. **audioStorage**: 音频设置存储
   - 音效开关状态
   - 音量设置

#### 4.4.2 数据结构

历史记录数据结构：
```
{
  version: "1.0",
  records: [
    {
      id: "unique_id",
      timestamp: 1705312225000,
      question: "问题内容",
      questionType: "yes_no" | "info",
      finalStatus: "yes|no|conditional|info|error",
      answers: [
        {
          name: "melchior",
          status: "yes|no|conditional|info|error",
          response: "回答内容",
          conditions: ["条件1", "条件2"]
        },
        // balthasar, casper
      ]
    }
  ],
  lastUpdated: 1705312225000
}
```

### 4.5 音频效果系统

#### 4.5.1 音频功能

使用Web Audio API实现系统音效：

1. **决策音效**: 根据最终状态播放不同频率的音效
   - yes: 2000Hz
   - no/error: 3400Hz
   - conditional: 2700Hz
   - info: 2200Hz

2. **交互音效**: 按钮点击、状态变化等交互音效

3. **音量控制**: 用户可调节音效音量或完全关闭

#### 4.5.2 实现方式

通过自定义Hook `useMagiAudio` 封装Web Audio API功能，提供简洁的接口：
- `playOscillator(frequency, duration)`: 播放指定频率的音效
- `setEnabled(boolean)`: 启用/禁用音效
- `setVolume(number)`: 设置音量（0-1）

## 5. 界面设计

### 5.1 视觉风格

保持EVA原作中MAGI系统的视觉风格：

1. **配色方案**:
   - 主色: 橙色 (#ff8d00)
   - 背景: 深灰色 (#1a1a1a)
   - 状态色:
     - 绿色 (#52e691): 同意
     - 红色 (#a41413): 拒绝
     - 橙色 (#ff8d00): 条件
     - 蓝色 (#3caee0): 信息
     - 灰色 (#808080): 错误

2. **字体**:
   - 主字体: MAGI-Matisse (自定义字体)
   - 备用字体: monospace

3. **布局**:
   - 左侧: MAGI主界面、历史记录、输入框
   - 右侧: 贤者回答详情、设置按钮

### 5.2 响应式设计

使用CSS变量和媒体查询实现响应式设计：

1. **桌面布局**: 左右双栏布局
2. **平板布局**: 单栏布局，右侧内容移至底部
3. **移动布局**: 紧凑单栏布局，隐藏部分装饰元素

### 5.3 动画效果

使用CSS动画和React过渡效果：

1. **处理中动画**: 闪烁效果表示系统正在处理
2. **状态变化动画**: 颜色渐变表示状态变化
3. **模态框动画**: 淡入淡出效果
4. **历史记录展开/折叠动画**: 平滑过渡效果

## 6. 开发与部署流程

### 6.1 开发环境

1. **本地开发**:
   ```bash
   # 安装依赖
   npm install
   
   # 启动开发服务器
   npm run dev
   ```

2. **开发工具**:
   - ESLint: 代码质量检查
   - Prettier: 代码格式化
   - TypeScript: 类型检查

### 6.2 构建与部署

1. **构建流程**:
   ```bash
   # 构建生产版本
   npm run build
   ```

2. **部署选项**:
   - 静态网站托管 (Netlify, Vercel, GitHub Pages)
   - Docker容器化部署
   - 传统Web服务器部署

### 6.3 CI/CD集成

使用GitHub Actions实现持续集成/持续部署：

1. **自动测试**: 提交代码时运行测试
2. **自动构建**: 合并到主分支时构建应用
3. **自动部署**: 构建成功后部署到生产环境

## 7. 迁移策略

### 7.1 分阶段迁移

从Dash迁移到React+Vite采用分阶段策略：

1. **阶段一: 基础架构搭建**
   - 创建React+Vite项目
   - 设置TypeScript配置
   - 实现基础组件结构

2. **阶段二: 核心功能迁移**
   - 实现状态管理
   - 迁移AI服务逻辑
   - 实现本地存储功能

3. **阶段三: UI组件迁移**
   - 迁移MAGI核心组件
   - 实现历史记录功能
   - 实现设置功能

4. **阶段四: 优化与测试**
   - 性能优化
   - 兼容性测试
   - 用户体验改进

### 7.2 代码复用

尽可能复用现有代码：

1. **CSS样式**: 直接迁移现有CSS样式
2. **AI提示词**: 复用现有人格提示词
3. **工具函数**: 将JavaScript工具函数转换为TypeScript

## 8. 性能优化

### 8.1 前端优化

1. **代码分割**: 使用React.lazy和Suspense实现按需加载
2. **资源优化**: 优化字体、图片等静态资源
3. **缓存策略**: 实现智能缓存减少API调用
4. **渲染优化**: 使用React.memo和useMemo减少不必要的重渲染

### 8.2 API调用优化

1. **请求合并**: 合并多个API请求减少网络开销
2. **响应缓存**: 缓存相似问题的回答
3. **错误重试**: 实现智能错误重试机制
4. **请求节流**: 防止短时间内多次请求

## 9. 未来扩展

### 9.1 功能扩展

1. **多语言支持**: 实现国际化支持多种语言
2. **主题切换**: 支持明暗主题切换
3. **语音输入**: 添加语音输入功能
4. **导出功能**: 支持导出历史记录为PDF或JSON

### 9.2 技术扩展

1. **PWA支持**: 实现渐进式Web应用支持离线使用
2. **WebSocket**: 实现实时通信功能
3. **WebGL效果**: 添加更高级的视觉效果
4. **语音合成**: 添加语音回答功能

## 10. 总结

本重构方案将MAGI系统从Dash框架迁移到React+Vite框架，保持原有的视觉风格和功能特性，同时提升开发体验、性能和可维护性。通过使用现代前端技术和最佳实践，新版MAGI系统将提供更流畅的用户体验和更强大的功能扩展能力。

重构后的系统将完全在前端运行，用户的API密钥和问题数据仅保存在本地，确保了用户隐私和数据安全。同时，多供应商支持让用户可以灵活选择不同的AI服务提供商，根据自己的需求和预算进行配置。